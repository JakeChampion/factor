<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Factor WASM (WASI) runner</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 2rem; background: #0f172a; color: #e2e8f0; }
    h1 { margin: 0 0 1rem; }
    label { display: block; margin: 0.5rem 0 0.25rem; }
    input { width: 100%; padding: 0.35rem; border-radius: 6px; border: 1px solid #475569; background: #1e293b; color: inherit; }
    button { margin-top: 0.75rem; padding: 0.5rem 0.9rem; border: 1px solid #38bdf8; background: #0ea5e9; color: #0f172a; border-radius: 6px; font-weight: 600; cursor: pointer; }
    pre { background: #0b1221; border: 1px solid #1f2937; border-radius: 8px; padding: 0.75rem; min-height: 200px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Factor WASM (WASI) runner</h1>
  <p>Serves <code>factor.wasm</code> with a WASI shim; expects a <code>factor.image</code> alongside.</p>

  <label>WASM path</label>
  <input id="wasmPath" value="/factor.wasm">
  <label>Image path</label>
  <input id="imagePath" value="/factor.image">
  <button id="run">Run</button>

  <pre id="log"></pre>

  <script type="module">
    import {
      WASI,
      File,
      OpenFile,
      Directory,
      PreopenDirectory,
      ConsoleStdout,
    } from "https://unpkg.com/@bjorn3/browser_wasi_shim@0.4.2/dist/index.js";

    const logEl = document.getElementById("log");
    const append = (msg) => { logEl.textContent += msg + "\n"; };

    document.getElementById("run").onclick = async () => {
      logEl.textContent = "";
      const wasmPath = document.getElementById("wasmPath").value || "factor.wasm";
      const imagePath = document.getElementById("imagePath").value || "factor.image";

      const imageArg = (() => {
        const trimmed = imagePath.startsWith("/") ? imagePath.slice(1) : imagePath;
        const parts = trimmed.split("/");
        return parts[parts.length - 1] || "factor.image";
      })();

      append(`Loading ${wasmPath}...`);
      const wasmModule = await WebAssembly.compileStreaming(fetch(wasmPath));

      append(`Fetching ${imagePath} into in-memory FS...`);
      const imageData = await (await fetch(imagePath)).arrayBuffer();

      // Inline hello snippet; no external script needed.

      const stdoutFd = ConsoleStdout.lineBuffered((line) => append(line));
      const stderrFd = ConsoleStdout.lineBuffered((line) => append(line));
      const stdinFd = new OpenFile(new File(new ArrayBuffer(0), { readonly: true }));
      const files = new Map([
        [imageArg, new File(imageData, { readonly: true })],
      ]);
      const rootDir = new PreopenDirectory(".", files);

      const args = [
        wasmPath,
        `-image=${imageArg}`,
        "-no-user-init",
        '-e=USING: io "Hello from wasm" print flush',
      ];
      const env = []; // array of "KEY=value"
      const fds = [stdinFd, stdoutFd, stderrFd, rootDir];

      const wasi = new WASI(args, env, fds);

      try {
        const instance = await WebAssembly.instantiate(wasmModule, {
          wasi_snapshot_preview1: wasi.wasiImport,
        });
        append("Starting...");
        let a = wasi.start(instance);
        append("Finished.");
        append(`Exit code: ${a}`);
      } catch (err) {
        append(`Error: ${err}`);
        console.error(err);
      }
    };
  </script>
</body>
</html>
